{"version":3,"sources":["../src/httpService.js"],"names":["module","exports","app","httpOpt","loadNum","factory","status","url","onloadingDiv","document","getElementById","match","classList","remove","add","setting","nextUrl","name","value","service","$http","$q","$document","$location","AlertService","LoginService","EventBus","baseUrl","Loading","ErrorHandle","HttpSetting","loginUrl","config","base","Date","busy","body","style","cssText","idle","sendRequest","params","method","option","data","defer","httpLoading","displayLoading","notDisplayLoading","resourceCode","headers","defaults","common","location","href","entityTypeName","entityId","isMajorData","success","result","handle","then","resolve","reject","error","reason","errorContent","undefined","errorresponse","errortext","alert","title","content","promise","addHeaders","param","restful","httpType","unrestricted"],"mappings":"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","file":"httpService.js","sourcesContent":["module.exports = function (app, httpOpt) {\r\n    var loadNum = 0\r\n    app.factory('Loading', () => (status, url) => {\r\n        var onloadingDiv = document.getElementById('onloadingDiv')\r\n        if (!onloadingDiv) return\r\n\r\n        if (status) {\r\n            if (url.match('isReposNameRepeat')) return\r\n\r\n            loadNum++\r\n            onloadingDiv.classList.remove('hidden')\r\n        } else {\r\n            loadNum--\r\n            if (loadNum <= 0) {\r\n                loadNum = 0\r\n                onloadingDiv.classList.add('hidden')\r\n            }\r\n        }\r\n    })\r\n    app.factory('HttpSetting', [function () {\r\n        let setting = {\r\n            nextUrl: ''\r\n        }\r\n        return function (name, value) {\r\n            if (value) {\r\n                setting[name] = value\r\n            } else {\r\n                return setting[name]\r\n            }\r\n        }\r\n    }])\r\n    app.service(\"HttpService\", [\"$http\", \"$q\", \"$document\", \"$location\",\r\n        \"AlertService\", \"LoginService\", \"EventBus\", \"baseUrl\", 'Loading', \"ErrorHandle\", \"HttpSetting\",\r\n        function ($http, $q, $document, $location, AlertService, LoginService, EventBus, baseUrl, Loading, ErrorHandle, HttpSetting) {\r\n            var loginUrl = LoginService.config.base + 'authStatus?callback=JSON_CALLBACK&_t=' + (+new Date());\r\n\r\n            function busy(url) {\r\n                document.body.style.cssText = \"cursor: progress !important\";\r\n                Loading(true, url)\r\n            }\r\n\r\n            function idle() {\r\n                document.body.style.cssText = \"\";\r\n                Loading(false)\r\n            }\r\n\r\n            function sendRequest(url, params, method, option) {\r\n                var data, config\r\n                var defer = $q.defer();\r\n\r\n                if (httpOpt && httpOpt.httpLoading === 'manual') {\r\n                    if (option && option.displayLoading) {\r\n                        busy(url);\r\n                    }\r\n                } else {\r\n                    if (!option || (option && !option.notDisplayLoading)) {\r\n                        busy(url);\r\n                    }\r\n                }\r\n\r\n\r\n                resourceCode(option)\r\n\r\n                if (method === 'post' || method === 'put') {\r\n                    params.data && (params.data = JSON.stringify(params.data))\r\n                }\r\n\r\n                if (method === 'get' || method === 'delete') {\r\n                    data = params\r\n                } else {\r\n                    data = params.data\r\n                    config = {\r\n                        headers: params.headers\r\n                    }\r\n                }\r\n\r\n                $http.defaults.headers.common['currentUrl'] = location.href;\r\n\r\n                //如果url不匹配，删除权限设置头部\r\n                if (!url.match(HttpSetting('nextUrl'))) {\r\n                    delete $http.defaults.headers.common.entityTypeName \r\n                    delete $http.defaults.headers.common.entityId\r\n                    delete $http.defaults.headers.common.resourceCode \r\n                    delete $http.defaults.headers.common.isMajorData \r\n                }\r\n\r\n                $http[method](url, data, config).success(function (result) {\r\n                    idle();\r\n\r\n                    ErrorHandle.handle(result)\r\n                        .then(function (data) {\r\n                            defer.resolve(data);\r\n                        }, function (data) {\r\n                            defer.reject(data);\r\n                        });\r\n                }).error(function (reason, status) {\r\n                    idle();\r\n\r\n                    var errorContent = reason;\r\n                    if (reason != undefined && reason.errorresponse != undefined) {\r\n                        errorContent = reason.errorresponse.errortext;\r\n                    }\r\n\r\n                    if (status) {\r\n                        AlertService.alert({\r\n                            title: \"服务端异常\",\r\n                            content: '系统出了点小问题，请稍后重试！'\r\n                            //content: errorContent\r\n                        });\r\n                    }\r\n                    defer.reject(reason);\r\n                });\r\n\r\n                return defer.promise;\r\n            }\r\n\r\n            function resourceCode(option) {\r\n                if (option && option.resourceCode) {\r\n                    $http.defaults.headers.common.resourceCode = option.resourceCode\r\n                } else {\r\n                    delete $http.defaults.headers.common.resourceCode\r\n                }\r\n            }\r\n\r\n            function addHeaders(method, param) {\r\n                switch (method) {\r\n                    case 'get':\r\n                        return {\r\n                            params: param\r\n                        }\r\n                    case 'post':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'delete':\r\n                        return {\r\n                            data: JSON.stringify(param || {}),\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'put':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                }\r\n            }\r\n\r\n            function restful(httpType) {\r\n                return function (url, param, option) {\r\n                    var defer = $q.defer();\r\n\r\n                    if (option && option.unrestricted) {\r\n                        sendRequest(baseUrl + url, {\r\n                            params: param\r\n                        }, httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            });\r\n                    } else {\r\n                        sendRequest(baseUrl + url, addHeaders(httpType, param), httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            }\r\n                        );\r\n                    }\r\n\r\n                    return defer.promise;\r\n                }\r\n            }\r\n\r\n            return {\r\n                \"get\": restful('get'),\r\n                \"post\": restful('post'),\r\n                \"put\": restful('put'),\r\n                \"delete\": restful('delete'),\r\n            };\r\n        }\r\n    ]);\r\n}"]}